# Memory Log - 2026-02-26

## Resume PDF Generation System

### Completed Tasks
1. **Created simple HTML resume generator** (`generate_resume_simple.py`)
   - Reads all JSON data files (profile, experience, projects, skills, education)
   - Generates clean HTML with template-matching styles (#2c3e50, #2a9d8f colors)
   - Single-page layout (auto height, no pagination)
   - Output: `/root/.openclaw/workspace-resume-manager/project/public/resume-single.html`

2. **Updated API with new endpoint** (`/ady/api/resume/simple/pdf`)
   - Uses Puppeteer to convert simple HTML to PDF
   - Faster generation (~6 seconds)
   - System fonts (Noto Sans CJK SC) for Chinese support

3. **Optimized original PDF endpoint**
   - Reused browser instance for better performance
   - Reduced wait times

### Available URLs
- Simple HTML: https://yfarer.cn/ady/resume-single.html
- Simple PDF: https://yfarer.cn/ady/api/resume/simple/pdf
- Original PDF: https://yfarer.cn/ady/api/resume/download/pdf

### Technical Notes
- Puppeteer `setContent` works better than `goto` for file:// URLs
- System fonts already installed: Noto Sans CJK SC
- API runs on port 3001, proxied via Nginx

### Next Steps (from user request)
- Verify PDF content displays correctly
- Consider Markdown-to-PDF workflow as alternative
- Ensure all website content is reflected in generated PDFs

---

## Resume PDF API Service - Debugging Session

### Issues Fixed
1. **Content-Disposition Header Error** - Fixed invalid characters in filename by using ASCII-only filename "resume.pdf"
2. **Service Process Conflicts** - Killed zombie processes (PID 279957, 280613) that were interfering with new service startup
3. **API Endpoint Verification** - Confirmed `/api/resume/pdf` endpoint works correctly and returns valid PDF binary data

### Current Status
- API server running on port 3002 (PID verified)
- Direct API access works: `curl http://localhost:3002/api/resume/pdf` returns valid PDF
- Health check passes: `{"status":"ok","service":"resume-pdf-api"}`
- Nginx configuration updated with trailing slash handling for `/ady/api/resume/pdf` and `/ady/api/resume/pdf/`

### Technical Details
- PDF generation uses Puppeteer + pdf-lib approach
- A4 width fixed at 794px, height adaptive to content
- Base64 embedded images for avatar and project images
- Handlebars templating with Chinese theme (岁时记)

### Pending Tasks
- Reload Nginx to apply updated configuration
- Test API through Nginx proxy at `https://yfarer.cn/ady/api/resume/pdf`
- Debug sub-project images not displaying in generated PDF

---

## 部署配置备忘录

### 项目结构
```
workspace-resume-manager/
├── project/                    # React 前端项目源码
│   ├── src/                   # 源代码
│   ├── dist/                  # 构建输出目录
│   └── package.json           # 依赖和脚本
├── data/                      # JSON 数据文件
├── templates/                 # HTML/PDF 模板
├── api/                       # Node.js API 服务
│   └── pdf-server.js          # PDF 生成服务 (端口 3002)
└── output/                    # 生成的 PDF 输出
```

### 部署目录
- **网站根目录**: `/var/www/ady/`
- **Nginx 配置**: `/etc/nginx/conf.d/yfarer.cn.conf`

### 构建和部署命令
```bash
cd /root/.openclaw/workspace-resume-manager/project
npm run build                    # 构建项目
cp -r dist/* /var/www/ady/       # 复制到部署目录
```

### Nginx 关键配置 (岁时记项目)
```nginx
# 岁时记项目 - /ady 路径
location = /ady {
    return 301 /ady/;
}

location /ady/ {
    alias /var/www/ady/;         # ⚠️ 必须是 /var/www/ady/，不是 /ady/
    index index.html;
    try_files $uri $uri/ =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# 简历PDF生成 API (端口 3002)
location = /ady/api/resume/pdf {
    proxy_pass http://localhost:3002/api/resume/pdf;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
    proxy_buffering off;
}
```

### 常见错误
1. **403 Forbidden**: Nginx alias 指向错误目录（必须是 `/var/www/ady/` 不是 `/ady/`）
2. **缓存问题**: 浏览器缓存旧版本，添加 `?v=数字` 查询参数强制刷新
3. **API 502**: PDF 服务未启动，检查 `node pdf-server.js` 是否在运行

### 服务管理
```bash
# 检查 PDF API 服务
curl http://localhost:3002/api/health

# 重启 PDF API 服务
cd /root/.openclaw/workspace-resume-manager/api
pkill -f pdf-server
nohup node pdf-server.js > /tmp/resume-pdf-api.log 2>&1 &

# 重载 Nginx
sudo nginx -t && sudo nginx -s reload
```

### 访问地址
- 网站: https://yfarer.cn/ady/
- PDF API: https://yfarer.cn/ady/api/resume/pdf

---

## PDF 生成样式结构和配置 (最终版)

### 布局结构
- **上下结构**：头部 + 主体内容
- **头部**：浅青绿色背景 `rgb(245, 252, 251)`，包含头像、姓名、职位、联系方式
- **主体**：白色背景，包含个人介绍、专业技能、教育背景、工作经历、项目经历

### 配色方案
- **主色调**：`rgb(42, 157, 143)` 青绿色
- **标题色**：`rgb(38, 70, 83)` 深蓝绿色
- **正文色**：`rgb(44, 62, 80)` 深灰蓝色
- **辅助色**：`rgb(84, 110, 122)` 灰色
- **背景色**：`rgb(245, 252, 251)` 浅青绿色

### 区块图标 (SVG)
- 个人介绍：用户图标
- 专业技能：闪电图标
- 教育背景：毕业帽图标
- 工作经历：公文包图标
- 项目经历：图层图标

### 技能展示
- 双列网格布局
- 每个技能分类带背景色卡片
- 技能项用 `·` 分隔

### 教育背景
- 学校、专业、时间横向排列
- 荣誉列表带圆点标记

### 工作经历
- 公司名和时间横向排列
- 职位单独一行
- 职责列表带圆点标记

### 项目经历
- 项目名称和时间横向排列
- 角色单独一行
- 描述文字支持换行
- 子项目带左边框和序号
- 技术栈单独显示

### 关键配置
- **单页无限高度**：根据内容自动计算
- **A4 宽度**：210mm
- **字体**：Noto Sans SC, PingFang SC, Microsoft YaHei
- **换行处理**：使用 `breaklines` helper 将 `\n` 转为 `<br>`

---

## 网站项目显示样式结构和配置

### 项目卡片样式
- 顶部装饰条：`#1c1917` 黑色，hover 时动画效果
- 背景：`#f5f5f4/80` 半透明浅灰
- 边框：`border-stone-200`
- 阴影：`shadow-sm`，hover 时 `shadow-lg`

### 子项目展示
- 有图片：白色背景 + 边框，左侧显示应用图标
- 无图片：`bg-stone-50/50` 浅灰背景
- 标题：`font-serif` 衬线字体 + `text-stone-800`
- 副标题：`text-theme-primary` 主题色
- 描述：`text-sm text-stone-600 whitespace-pre-line` 支持换行

### 技术栈/工具/平台显示
- 标签形式横向排列
- 标签文字：`text-xs text-stone-400` 灰色
- 内容文字：`text-stone-600` 深灰
- 分隔符：`·` 或 `/`

### 访问链接按钮
- 背景：`bg-stone-200`
- 文字：`text-stone-800`
- Hover：`hover:bg-[#1c1917] hover:text-[#e7e5e4]`
- 圆角：`rounded-lg`
- 过渡：`transition-all duration-300`

### 关键配置
- **背景文字位置**：只在页面顶部 0-8% 和底部 92-100% 显示，避开中间内容区域
- **数据优先从 Supabase 获取**：失败时回退到本地 JSON
- **子项目描述**：使用 `whitespace-pre-line` 支持换行显示

---

## 加载状态组件 (LoadingScreen)

### 文件位置
`/root/.openclaw/workspace-resume-manager/project/src/components/LoadingScreen.tsx`

### 样式结构
- **背景**：`#f5f5f4` 浅灰
- **印章**：24x24 像素，边框 4px `#2c3e50`
- **文字**：`岁时记` 衬线字体 + `简历` 小字
- **装饰圆点**：弹跳动画，不同延迟
- **进度条**：渐变滑动动画

### 使用方式
```tsx
<LoadingScreen isLoading={profileLoading} />
```

### 触发时机
- `profileLoading` 为 true 时显示
- 数据加载完成后自动消失

---

## 每周自动更新任务

### 统一更新任务
- **ID**: 5b2963b6-fa8f-4ed6-b793-deb1937740ec
- **名称**: 统一每周更新-个人介绍和技能学习
- **执行 Agent**: resume-manager
- **时间**: 每周一上午 9:00 (北京时间)
- **脚本**: `/root/.openclaw/workspace-resume-manager/scripts/unified-weekly-update.sh`

### 更新内容
1. **个人介绍更新** (`weekly-profile-update.sh`)
   - 从所有 Agent 会话中提取信息
   - 从技能学习记录中总结
   - 生成概括性描述（不提及具体项目）
   - 更新本地 JSON 和数据库
   - 发送 Telegram 通知

2. **技能学习追踪** (`unified-skill-tracker.mjs`)
   - 从所有 Agent 会话中提取技能关键词
   - 按分类保存到 `skill_learning_logs` 表
   - 发送 Telegram 通知

3. **网站重新构建部署**
   - 执行 `npm run build`
   - 复制到 `/var/www/ady/`
   - 发送完成通知

### 通知消息
- 个人介绍更新：包含会话数量、技能记录数量、新描述预览
- 技能学习追踪：包含分类和技能列表
- 完成通知：包含更新摘要和下次更新时间

---

## PDF API 数据库适配修复记录

### 问题与修复

#### 1. 头像显示错误
**问题**: 数据库中 avatar 字段是随机图片 URL (`picsum.photos`)
**修复**: 检测并替换为 `/ady/avatar.png`
```javascript
avatar: profile.avatar && !profile.avatar.includes('picsum.photos') ? profile.avatar : '/ady/avatar.png'
```

#### 2. 工作经历缺少担任角色
**问题**: 映射字段错误，使用了 `position` 而不是 `role`
**修复**: 改为 `exp.role`

#### 3. 技能分类标题不显示
**问题**: 数据库字段是 `title`，代码中使用 `cat.name`
**修复**: 改为 `cat.title`

#### 4. 子项目标题不显示
**问题**: 数据库字段是 `title`，代码中使用 `sub.name`
**修复**: 改为 `sub.title`

#### 5. 技术栈重复显示
**问题**: 数据库 description 已包含技术栈文字，又单独显示 techStack
**修复**: 删除数据库 description 中的技术栈文字，保留 tech_stack 数组

#### 6. 项目描述没有分行/序号
**问题**: 数组格式的 description 直接 join，没有序号
**修复**: 数组项添加序号后 join
```javascript
description: Array.isArray(proj.description) 
  ? proj.description.map((item, index) => `${index + 1}. ${item}`).join('\n')
  : proj.description
```

#### 7. Puppeteer Chrome 路径
**问题**: 找不到 Chrome 可执行文件
**修复**: 指定 `executablePath: '/usr/bin/google-chrome'`

#### 8. 个人介绍动态生成
**问题**: PDF 中个人介绍与网站不一致，缺少动态生成的技能、项目、笔记信息
**修复**: 添加动态生成逻辑，与网站 `generateDynamicAbout` 函数保持一致

```javascript
// 动态生成个人介绍（与网站一致）
let dynamicAbout = profile.about || '';

// 获取最新的技能（前3个）
const skillNames = skillCategories?.flatMap(cat => 
  cat.skills?.slice(0, 3).map(s => s.name)
) || [];

// 获取最新的项目（前2个）
const latestProjects = projects?.slice(0, 2).map(p => p.name) || [];

// 添加技能描述
if (skillNames.length > 0) {
  dynamicAbout += ` 目前专注于${skillNames.slice(0, 3).join('、')}等技术领域。`;
}

// 添加项目描述
if (latestProjects.length > 0) {
  dynamicAbout += ` 近期正在开发${latestProjects.join('、')}等项目。`;
}

// 添加笔记描述
const { data: notes } = await supabase
  .from('notes')
  .select('id')
  .eq('status', 'published');
const notesCount = notes?.length || 0;
if (notesCount > 0) {
  dynamicAbout += ` 持续学习并记录了${notesCount}篇技术笔记。`;
}
```

**生成逻辑**:
1. 基础介绍（来自数据库 `profiles.about`）
2. 技能领域（前3个技能）- "目前专注于 n8n、Dify、Coze 等技术领域。"
3. 开发项目（前2个项目）- "近期正在开发 AI编程工具应用、Coze工作流与智能体开发等项目。"
4. 笔记记录（已发布笔记数量）- "持续学习并记录了 X 篇技术笔记。"

### 当前状态
- PDF API 从 Supabase 数据库读取数据 ✅
- 头像、工作经历、技能、项目均正常显示 ✅
- 有序列表格式正确 ✅
- 个人介绍动态生成与网站一致 ✅
